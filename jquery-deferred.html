<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>jQuery Callbacks and Deferred</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/black.css" id="theme">
    <link rel="stylesheet" href="lib/css/zenburn.css">
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <section data-markdown>
            # jQuery 源码阅读
            
            ## Deferred, Promise 和 异步编程
            
          </section>
          <section data-markdown>
            ## 概要
            - 异步编程 回调
            - Deferred 和 Callbacks
            - Deferred 和 Promise
            
          </section>
        </section>
        <section>
          <section>
            <div data-markdown>
              ## 回调
              
                  $.get('/foo', function(){
                      // 后执行
                  });
                  // 先执行
            </div>
            <p class="fragment">消息循环, 消息队列</p>
            <p class="fragment">requestAnimationFrame, setImmediate(node), nextTick(node)</p>
            <p class="fragment">setTimeout</p>
          </section>
          <section data-markdown>
            ## 实现回调
            ```js
            function get(url, callback){
                var xhr = new XMLHttpRequest();
                xhr.onreadystatechange = function(){
                    ...
                    callback(...);
                    // callback.call({}, ...);
                    // callback.apply({}, ...);
                };
            }
            ```
            note:
            10min
                
          </section>
          <section data-markdown>
            ## 串联
            ```js
            $.get('/url1', function(data){
                $.get('/url2', data, function(data){
                    $.get('/url3', data, function(data){
                        // url3 response
                    });
                });
            });
            ```
          </section>
          <section>
            <h2>串联: 直观的办法</h2>
            <div data-markdown>
              ```js
              waterfall([
                  function(callback){
                      ... // query DB
                      callback(null, dbData);
                  },
                  function(callback){
                      ... // read File
                      callback(null, fileData);
                  },
                  function(callback){
                      ... // result
                      callback(null, 'result');
                  }
              ], function(err, result){
                  // result is 'result'
              });
              ```
              note:
              API多, 根据不同场景选择不同API
              
            </div>
            <p class="fragment">延伸: 并联 <a href="https://github.com/caolan/async">async</a></p>
          </section>
        </section>
        <section>
          <section data-markdown>
            ## jQuery Deferred
            
                $.get('/url1').then(function(data){
                    return $.get('/url2', data);
                }).then(function(data){
                    return $.get('/url3', data);
                }).then(function(){
                    // url3 response
                });
            note:
            20min
          </section>
          <section data-markdown>
            ## jQuery Deferred 的实现概览
            
            - Deferred
                - callbacks
                - pipe
                - then
                - deferred
            - $.when
            
            note:
            - pipe 向后兼容, 转接参数到done(args0) fail(args1) progress(args2)
            - 返回新deferred: newDefer, 行为取决于args0~2的返回值
              - promise: 转接到newDefer
              - 其它: newDefer.resolveWith(this, arguments)
          </section>
          <section data-markdown>
            ## jQuery Callbacks 使用示例
            
                function fn1(value){ console.log(value); }
                function fn2(value){ console.log('fn2 says: ' + value); }
                
                var cbs = $.Callbacks();
                cbs.add(fn1);
                cbs.fire('foo!');
                // foo!
                cbs.add(fn2);
                cbs.fire('bar!');
                // bar!
                // fn2 says: bar!
                
            pub/sub
            
            note:
            30min
          </section>
          <section data-markdown>
            ## jQuery Callbacks 源码速览
            ```js
            jQuery.Callbacks = function( options ) {
                createOptions(...)
                var firing, memory, fired, list=[], queue=[], ....
                fire = function(){
                    locked = options.once;
                    fired = firing = true;
                    for( queue ...){
                        memory = queue.shift();
                        while(list...){
                            if(list[i].apply(memory[0], memory[1]) === false ...){
                                // break
                            }
                        }
                    }
                    // reset and clean up
                },
                self = {
                    add: function(){
                        if(memory){
                            firingIndex = list.length - 1;
                            queue.push( memory );
                        }
                        (function add(args){
                            $.each(function(){
                                if( isFunction ...){
                                    list.add(arg);
                                }else{
                                    add(arg);
                                }
                            });
                        }(arguments));
                        if ( memory && !firing ) {
                            fire();
                        }
                    },
                    disable: function() { // 禁用后续的fire和add调用
                        locked = queue = [];
                        list = memory = "";
                    },
                    lock: function() { // 禁用后续的fire调用
                        locked = queue = [];
                        ...
                    },
                    fireWith: function(){
                        args = [ context, args.slice ? args.slice() : args ];
                        queue.push( args );
                        ...
                        fire();
                    },
                    remove: ..., has: ..., empty: ..., disabled: ..., locked: ..., fire: ..., fired: ... };
                return self;
            }
            ```
          </section>
          <section data-markdown>
            ## jQuery Callbacks options
            
            - `once` 只允许fire一次, 之后的fire将不生效
            - `memory` 每次add时会尝试用最近一次fire的值, 并立即触发fire(内部fire, 不受locked限制)
            - `unique` callback必须唯一, 防止重复add 相同 callback
            - `stopOnFalse` 如果有callback反悔false, 不再执行后续的callback
            
            note:
            30min
          </section>
          <section data-markdown>
            ## jQuery Deferred 源码速览
            ```js
                var tuples = [
                    [ "notify", "progress", jQuery.Callbacks("memory"), jQuery.Callbacks("memory"), 2 ],
                    [
                        "resolve",                       // 0 action
                        "done",                          // 1 add listener
                        jQuery.Callbacks("once memory"), // 2 callbacks
                        jQuery.Callbacks("once memory"), // 3 then handlers
                        0,                               // 4 argument index
                        "resolved"                       // 5 [final state]
                    ],
                    [ "reject", "fail", jQuery.Callbacks("once memory"), jQuery.Callbacks("once memory"), 1, "rejected" ]
                ],
                promise = {
                    state:..., always:..., catch:..., pipe:...,
                    then: function(){
                        return jQuery.Deferred(function(newDefer){
                            tuples[0 ~ 2][3].add(resolve(0, newDefer, onFulfilled/onRejected, /* newDefer.notifyWith */));
                        });
                        function resolve(depth, deferred, handler, special){
                            return function(){
                                var that = this, args = arguments,
                                mightThrow = function(){
                                    // TODO
                                },
                                process = function(){
                                    try{
                                        mightThrow()
                                    }catch(e){
                                        deferred.rejectWith(
                                    }
                                };
                                if ( depth ) {
                                    process();
                                } else {
                                    window.setTimeout( process );
                                }
                            };
                        }
                    }
                },
                deferred = {};
                $.each(tuples, function(i, tuple){
                    var list = tuple[ 2 ];
                    promise.done/fail/progress = list.add;
                    list.add(tuple[3].fire);
                    deferred.resolve/reject/notify = function(){ deferred.resolveWith(...) };
                    deferred.resolveWith = list.fireWith;
                });
                jQuery.extend(deferred, promise);
                
                if ( func ) {
                    func.call( deferred, deferred );
                }
                return deferred;
                
            ```
            note:
            45min
          </section>
          <section data-markdown>
            ## jQuery Deferred when 源码速览
            
          </section>
        </section>
        <section>
          <section data-markdown>
            ## Promise
            ```js
            
            ```
            note:
            55min
            https://github.com/jakearchibald/es6-promise
            
          </section>
          <section data-markdown>
            ## Deferred 和 Promise
            
          </section>
          <section data-markdown>
            ## es6 promise
            https://github.com/petkaantonov/bluebird/tree/master/benchmark
            
          </section>
          <section data-markdown>
            ## generator 和 promise
            https://github.com/tj/co
            async/await
          </section>
        </section>
      </div>
    </div>
    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>
    <script>(function() {
  Reveal.initialize({
    controls: true,
    progress: true,
    history: true,
    center: true,
    transition: 'slide',
    dependencies: [
      {
        src: 'lib/js/classList.js',
        condition: function() {
          return !document.body.classList;
        }
      }, {
        src: 'plugin/markdown/marked.js',
        condition: function() {
          return !!document.querySelector('[data-markdown]');
        }
      }, {
        src: 'plugin/markdown/markdown.js',
        condition: function() {
          return !!document.querySelector('[data-markdown]');
        }
      }, {
        src: 'plugin/highlight/highlight.js',
        async: true,
        condition: function() {
          return true;
        },
        callback: function() {
          hljs.initHighlightingOnLoad();
        }
      }, {
        src: 'plugin/zoom-js/zoom.js',
        async: true
      }, {
        src: 'plugin/notes/notes.js',
        async: true
      }
    ]
  });

}).call(this);

    </script>
  </body>
</html>